---
- name: Deploy web-site
  hosts: ocean
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python
#  vars_prompt:
#    - name: commit
#      prompt: "What is the commit name?"
#      private: no

  tasks:
    - name: copy to tmp subfolder for native compilation
      delegate_to: localhost
      synchronize:
        src: '{{playbook_dir}}'
        dest: '{{playbook_dir}}/tmp'
        rsync_opts:
          - "--exclude=.dart_tool"
          - "--exclude=.git"
          - "--exclude=tmp"

    - meta: end_play

    - name: webpack build for production
      delegate_to: localhost
      shell: webpack

    - name: git push
      delegate_to: localhost
      shell: git add -A && git commit -m "{{ commit }}" ; git push origin master

    - name: git pull
      shell: cd /home/tabula/denisbakhtin/itblog && git pull origin master

    - name: stop service
      shell: systemctl stop itblog
      become: yes

    - name: clean old binaries (itblog-go & periodic-go)
      shell: cd /home/tabula/denisbakhtin/itblog && rm -rf *-go

    - name: build new binary
      shell: cd /home/tabula/denisbakhtin/itblog && /home/tabula/golang/bin/go build -o itblog-go

    - name: build new periodic command binary
      shell: cd /home/tabula/denisbakhtin/itblog && /home/tabula/golang/bin/go build -o periodic-go cmd/periodical/main.go

    - name: start service
      shell: systemctl start itblog
      become: yes
